## 💡 **프로세스 표현 가이드**

- 프로세스를 가장 잘 설명할 수 있는 방식을 사용하여 작성합니다. (Flowchart, BPMN, Sequence Diagram, Use Case, User Journey 등)
- BPMN의 경우 UML만 허용되며, 나머지는 Mermaid로 작성해야 합니다.
- 다이어그램만으로 설명이 부족할 경우, 각 단계의 세부 내용이나 비즈니스 규칙을 보충 설명합니다.

---

### **프로세스 개요**

| 항목 | 설명 |
| :--- | :--- |
| **목적** | 기사가 배차된 운행을 시작하여 승객을 목적지까지 안전하게 이동시킨 후, 요금을 정산하고 관리자가 해당 주행 내역을 최종적으로 확인 및 처리하는 전체 과정을 정의합니다. |
| **시작 조건** | 관리자가 예약을 기사에게 배차 완료한 상태이며, 기사는 기사앱에 출근 상태로 로그인 되어 있습니다. |
| **종료 조건** | 주행이 완료되고 요금 결제(또는 미결제 처리)가 끝났으며, 관리자가 주행 내역에 대한 후처리를 완료하여 기록이 확정됩니다. |

---

### **프로세스 표현 (Flowchart)**

```mermaid
flowchart TD
    subgraph "기사 (Driver App)"
        A[배차 내역 선택 및 출발] --> B{승객 탑승 확인};
        B --> C[주행 시작];
        C --> D{경유지/목적지 도착};
        D -- 경유지 --> E[일부 승객 하차/탑승 처리];
        E --> C;
        D -- 최종 목적지 --> F[모든 승객 하차 및 주행 완료];
        F --> G[결제 내역 확인 및 요금 수정(필요시)];
        G --> H{결제 수단 선택};
        H --> I[카드/삼성페이 결제];
        H --> J[현금 결제];
        H --> K[미결제 처리];
        I --> L{결제 성공?};
        L -- Yes --> M[결제 완료 및 영수증 출력];
        L -- No --> N[결제 실패/재시도];
        J --> M;
        K --> O[미결제 사유 선택];
        O --> M;
        N --> H;
        C --> P[주행 강제 종료(관리자/기사)];
    end

    subgraph "시스템 (Backend)"
        A ==> S0[안심번호 할당];
        C ==> S1[상태 '운행중'으로 변경 및 위치 데이터 수집];
        F ==> S2[주행 종료 및 최종 요금 계산];
        M ==> S3[주행/결제 내역 저장];
        P ==> S4[강제 종료 시점까지 주행 기록 저장 및 정책 기반 요금 처리];
    end

    subgraph "관리자 (Admin System)"
        S3 ==> ADM1[주행 상세 내역 조회];
        ADM1 --> ADM2{내역 수정 필요?};
        ADM2 -- Yes --> ADM3[탑승자/요금/결제 정보 수정];
        ADM3 --> ADM4[최종 내역 확정];
        ADM2 -- No --> ADM4;
        S4 ==> ADM1;
    end

    style P fill:#f9f,stroke:#333,stroke-width:2px
    style S4 fill:#f9f,stroke:#333,stroke-width:2px
```

---

### **상세 절차**

| 단계 | 수행자 | 행동 (Action) | 상세 설명 |
| :--- | :--- | :--- | :--- |
| 1 | 기사 | 배차 내역 선택 및 운행 시작 | 기사앱 홈 화면에서 배정된 예약 건을 선택하고, 내비게이션을 통해 승객 탑승지로 이동합니다. |
| 2 | 기사 | 승객 탑승 및 주행 시작 | 승객 탑승 후, 앱에서 '주행 시작' 버튼을 누릅니다. 필요 시, 미예약 동승자를 추가할 수 있습니다. |
| 3 | 시스템 | 주행 상태 기록 | 기사가 '주행 시작'을 누르면, 관리자 시스템의 해당 예약 상태가 '운행중'으로 변경되고 OBD를 통해 차량 위치 데이터 수집이 시작됩니다. |
| 4 | 기사 | 목적지 이동 및 하차 처리 | 내비게이션 안내에 따라 목적지(또는 경유지)로 이동합니다. 경유지 도착 시, 하차/탑승 인원을 처리하고 다음 목적지로 주행을 계속합니다. |
| 5 | 기사 | 주행 완료 | 최종 목적지에서 모든 승객이 하차하면 앱에서 '주행 완료' 처리를 합니다. |
| 6 | 시스템 | 요금 자동 계산 | 주행이 완료되면 시스템은 OBD로 측정된 거리, 센터별 요금제 등을 기반으로 최종 요금을 자동 계산하여 기사앱에 표시합니다. |
| 7 | 기사 | 요금 확인 및 결제 진행 | 계산된 요금을 승객에게 안내하고 결제를 진행합니다. 필요 시(거리 계산 오류 등), 관리자와 협의하여 요금을 수정할 수 있습니다. |
| 8 | 기사 | 결제 처리 (성공) | 승객이 선택한 결제 수단(카드, 현금 등)으로 결제를 완료합니다. 설정에 따라 영수증이 자동으로 출력될 수 있습니다. |
| 9 | 기사 | 결제 처리 (실패/미결제) | 카드 결제 실패 시 재시도하거나, 즉시 결제가 어려운 경우 '미결제'로 처리하고 사유를 선택합니다. 미결제 건은 추후 '운행 내역' 메뉴에서 재결제할 수 있습니다. |
| 10 | 시스템 | 주행 및 결제 내역 저장 | 결제가 완료되면, 주행 상세 정보(이동 경로, 시간, 거리)와 결제 정보(결제 수단, 금액, 시간)가 서버에 최종 저장됩니다. |
| 11 | 관리자 | 주행 내역 확인 및 후처리 | 관리자는 운행이 종료된 건에 대해 주행 상세 정보를 조회합니다. 필요 시, 탑승자 정보(미탑승 처리 등), 요금, 결제 내역 등을 수정하여 최종 확정합니다. |
| 12 | 시스템 / 관리자 | 주행 강제 종료 처리 | 비상 상황 발생 시 관리자가 원격으로 또는 기사가 앱에서 주행을 강제 종료할 수 있습니다. 이 경우, 종료 시점까지의 기록을 기반으로 요금이 산정되며 관리자의 후처리가 필요합니다. (정책 정의 필요: `Hd1_b1_d1`) |
